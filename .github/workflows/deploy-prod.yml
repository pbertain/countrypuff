name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no changes'
        required: false
        default: false
        type: boolean

jobs:
  deploy-prod:
    name: Deploy to Production Environment
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Ansible
      run: |
        python -m pip install --upgrade pip
        pip install ansible

    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh/keys
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/keys/nirdclub__id_ed25519
        chmod 600 ~/.ssh/keys/nirdclub__id_ed25519
        ssh-keyscan -H host74.nird.club >> ~/.ssh/known_hosts

    - name: Test SSH connection
      run: |
        ssh -i ~/.ssh/keys/nirdclub__id_ed25519 -o ConnectTimeout=10 ansible@host74.nird.club "echo 'SSH connection successful'"

    - name: Run Ansible deployment
      run: |
        cd /home/runner/work/countrypuff/countrypuff
        ansible-playbook \
          -i ansible/inventories/hosts.yml \
          -l production \
          ansible/playbooks/deploy.yml \
          --private-key ~/.ssh/keys/nirdclub__id_ed25519 \
          --diff \
          -v
      env:
        ANSIBLE_HOST_KEY_CHECKING: false

    - name: Verify deployment
      run: |
        echo "Waiting for application to start..."
        sleep 30
        
        # Test API endpoint
        response=$(curl -s -o /dev/null -w "%{http_code}" http://host74.nird.club:63080/api || echo "000")
        if [ "$response" = "200" ]; then
          echo "‚úÖ Production deployment successful!"
          echo "üåç Application is available at: http://host74.nird.club:63080"
        else
          echo "‚ùå Deployment verification failed. HTTP status: $response"
          exit 1
        fi

    - name: Post deployment info
      if: success()
      run: |
        echo "üöÄ Production Deployment Complete!"
        echo "üìç URL: http://host74.nird.club:63080"
        echo "üîó API: http://host74.nird.club:63080/api"
        echo "üìã Docs: http://host74.nird.club:63080/docs"
        echo "üîç Test: curl http://host74.nird.club:63080/api/countries/US"

    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå Production deployment failed!"
        echo "Check the logs above for details."
        echo "You can also check the service status with:"
        echo "ssh -i ~/.ssh/keys/nirdclub__id_ed25519 ansible@host74.nird.club 'systemctl status countrypuff-prod'"